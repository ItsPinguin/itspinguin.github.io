<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Gravity Sim</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script>
        function setTab(tabButton) {
            const tabName = tabButton.getAttribute('tab-button')
            const tabGroup = tabButton.getAttribute('tab-group')
            document.querySelectorAll('[tab-panel]').forEach (elt =>{
                const group = elt.getAttribute('tab-group') || tabGroup
                if (group === tabGroup) { 
                    const tab = elt.getAttribute('tab-panel')
                    elt.classList.toggle('hidden', tabName !== tab);    
                }        
            })

            document.querySelectorAll('[tab-button]').forEach (button => {
                const active = button.getAttribute('tab-button') === tabName && button.getAttribute('tab-group') === tabGroup;
                button.classList.toggle('bg-stone-700', active);
                button.classList.toggle('bg-stone-800', !active);
            })
        }

        let active_tool = 0
        function setTool(tool) {
            active_tool = tool
            console.log('tool is now', active_tool)
        }

        window.draggable = {}
        function startDragging(elt) {
            window.draggable[elt.getAttribute('[draggable-input]')] = Date.now()
        }

        function endDragging(elt) {
            previous = window.draggable[elt.getAttribute('[draggable-input]')]
        }
    </script>
    <style>
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
          -webkit-appearance: none;
          margin: 0;
        }

        input[type=number] {
          -moz-appearance: textfield;
        }
    </style>
</head>
<body class="overflow-hidden bg-black m-0 font-sans bg-mauve-950 h-screen select-none">
    <!-- MAIN APP LAYOUT -->
    <div class="flex flex-row justify-between h-full w-screen bg-linear-to-t from-stone-950 to-stone-900">
        <!-- LEFT PANEL -->
        <div class="p-2 z-10 h-full">
            <div class="z-10 bg-stone-900 rounded-xl border border-stone-700 text-stone-200  w-64 xl:w-72 h-full backdrop-blur-sm">
                <div class="flex flex-row h-full">
                    <!-- BUTTON CONTAINER -->
                    <div class="flex flex-col gap-2 border-r border-stone-700 p-2">
                        <div onclick="setTab(this);setTool(0)" tab-group="tools" tab-button="move" 
                        class="bg-stone-700 hover:bg-stone-700 size-8 rounded-md cursor-pointer
                        flex items-center justify-center">
                            x
                        </div>
                        <div onclick="setTab(this);setTool(1)" tab-group="tools" tab-button="add" 
                        class="bg-stone-800 hover:bg-stone-700 size-8 rounded-md cursor-pointer
                        flex items-center justify-center">
                            +
                        </div>
                        <div onclick="setTab(this);setTool(2)" tab-group="tools" tab-button="simulation" 
                        class="bg-stone-800 hover:bg-stone-700 size-8 rounded-md cursor-pointer
                        flex items-center justify-center">
                            %
                        </div>
                    </div>
                    <!-- TOOLS CONTAINER -->
                    <div class="w-full">
                        
                        <div class="w-full h-full p-2" tab-group="tools" tab-panel="move">
                            <p class="text-white text-md mb-2">Move and zoom</p>
                            <div class="mb-1 flex flex-row gap-4 justify-between w-full">
                                <p class="text-gray-400 text-sm">View X</p>
                                <input id="view-x" type="number" id="mRange" min="-1000" max="1000" value="0.0" class="focus:bg-stone-800 text-sm bg-stone-700 rounded-sm px-1 w-1/2 text-right outline-none">
                            </div>
                            <div class="mb-1 flex flex-row gap-4 justify-between w-full">
                                <p class="text-gray-400 text-sm">View Y</p>
                                <input id="view-y" type="number" id="mRange" min="-1000" max="1000" value="0.0" class="focus:bg-stone-800 text-sm bg-stone-700 rounded-sm px-1 w-1/2 text-right outline-none">
                            </div>
                            <div class="mb-2 flex flex-row gap-4 justify-between w-full">
                                <p class="text-gray-400 text-sm">Zoom</p>
                                <input id="view-zoom" type="number" id="mRange" min="1" max="1000" value="1.0" class="focus:bg-stone-800 text-sm bg-stone-700 rounded-sm px-1 w-1/2 text-right outline-none">
                            </div>
                        </div>
                        <div class="w-full h-full p-2" tab-group="tools" tab-panel="add">
                            <p class="text-white text-md mb-2">Add Body</p>
                            <div class="mb-1 flex flex-row gap-4 justify-between w-full">
                                <p class="text-gray-400 text-sm">Mass</p>
                                <input type="number" id="mRange" min="-1000" max="1000" value="10" class="focus:bg-stone-800 text-sm bg-stone-700 rounded-sm px-1 w-1/2 text-right outline-none">
                            </div>
                        </div>
                        <details hidden class="mb-2 cursor-pointer w-full hidden" open tab-group="tools" tab-panel="add">
                            <summary class="flex items-center mb-2">
                                <div class="flex-grow border-t border-stone-700"></div>
                            
                                <span class="mx-2 flex-shrink-0 text-xs font-bold uppercase tracking-widest text-blue-400">
                                    New bodies
                                </span>
                            
                                <div class="flex-grow border-t border-stone-700"></div>
                            </summary>

                            <div class="mb-2 flex flex-row gap-4 justify-between w-full">
                                <label id="mRangeLabel" class="block text-sm mb-1 text-gray-400">Mass</label>
                                <input type="number" id="mRange" min="-1000" max="1000" value="10" class="accent-blue-500 text-sm bg-blue-900/50 rounded-sm px-1 w-16">
                            </div>
                        </details>
                        <div class="w-full h-full p-2" tab-group="tools" tab-panel="simulation">
                            <p class="text-white text-md mb-2">Simulation</p>
                            <div class="mb-1 flex flex-row gap-4 justify-between w-full">
                                <p class="text-gray-400 text-sm">Gravity</p>
                                <input id="gravityRange" type="number" id="mRange" min="-1000" max="1000" value="0.0" class="focus:bg-stone-800 text-sm bg-stone-700 rounded-sm px-1 w-1/2 text-right outline-none">
                            </div>
                            <button onclick="requestReset()" class="mt-2 w-full bg-stone-700 hover:bg-stone-600 py-2 rounded-sm transition text-sm">
                                Reset Simulation
                            </button>

                        </div>
                    </div>
                </div>


            </div>
        </div>
        <!-- CANVAS -->
        <div class="flex-grow relative p-2">
            <canvas id="glcanvas" class="rounded-lg bg-black w-full h-full border"></canvas>
        </div>
        <!-- RIGHT PANEL -->
        <div hidden class="p-2 z-10 h-full">
            <div class="z-10 bg-gray-900/80 p-4 rounded-xl border border-gray-700 text-white w-64 backdrop-blur-md">Simulation & Explorer
                <details class="mb-2 cursor-pointer" open>
                    <summary class="flex items-center mb-2">
                        <div class="flex-grow border-t border-gray-700"></div>
                    
                        <span class="mx-2 flex-shrink-0 text-xs font-bold uppercase tracking-widest text-blue-400">
                            Simulation Properties
                        </span>
                    
                        <div class="flex-grow border-t border-gray-700"></div>
                    </summary>

                    <div class="mb-2 flex flex-row gap-4 justify-between w-full">
                        <label id="gLabel" class="block text-sm text-gray-400 mb-1">Gravity Strength</label>
                        <input type="number" id="gravityRange" min="-10000" max="10000" value="0" class="accent-blue-500 text-sm bg-blue-900/50 rounded-sm px-1 w-16">
                    </div>
                </details>
            </div>
        </div>
    </div>

    <script src="https://not-fl3.github.io/miniquad-samples/mq_js_bundle.js"></script>
    <script>
        miniquad_add_plugin({
            register_plugin: function (importObject) {
                // This 'env' object is where Rust's extern "C" looks
                importObject.env = importObject.env || {};
                
                importObject.env.get_gravity_value = function () {
                    const val = parseFloat(document.getElementById("gravityRange").value);
                    return isNaN(val) ? 0.0 : val;
                };
                importObject.env.get_spawning_mass = function () {
                    const val = parseFloat(document.getElementById("mRange").value);
                    return isNaN(val) ? 0.0 : val;
                };
                importObject.env.should_reset_simulation = function () {
                    if (window.resetRequested) {
                        window.resetRequested = false; // Reset the toggle
                        return 1.0;            // Tell Rust to clear
                    }
                    return 0.0;
                };
                importObject.env.get_active_tool = function () { 
                    return active_tool
                }

                importObject.env.update_ui_view_pos = function(x, y, zoom) {
                    console.log('test', x, y, zoom)
                    document.getElementById('view-x').value = x.toFixed(2);
                    document.getElementById('view-y').value = y.toFixed(2);
                    document.getElementById('view-zoom').value = zoom.toFixed(2);
                };
            }
        });
        function requestReset() { window.resetRequested = true; }
        load("/assets/data/projects/rusty_gravity/rusty-gravity.wasm");

        
    window.addEventListener('mouseup', () => {
        isDragging = false;
    });
    </script>
</body>
</html>